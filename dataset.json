const { app, BrowserWindow, ipcMain, dialog } = require("electron");
const path = require("path");
const fs = require("fs");
const { spawn } = require("child_process");
const yaml = require("js-yaml");

let mainWindow;
let loginWindow;

function createLoginWindow() {
  loginWindow = new BrowserWindow({
    width: 600,
    height: 700,
    resizable: false,
    frame: true, // Hoáº·c false náº¿u báº¡n muá»‘n giao diá»‡n tÃ¹y chá»‰nh
    webPreferences: {
      preload: path.join(__dirname, "preload.js"),
      contextIsolation: true,
      nodeIntegration: false,
    },
  });

  loginWindow.loadFile(path.join(__dirname, "../renderer/pages/login.html"));
  loginWindow.on("closed", () => (loginWindow = null));
}

function createMainWindow() {
  mainWindow = new BrowserWindow({
    webPreferences: {
      preload: path.join(__dirname, "preload.js"),
      contextIsolation: true,
      nodeIntegration: false,
    },
  });
  mainWindow.maximize();
  mainWindow.loadFile(path.join(__dirname, "../renderer/pages/index.html"));
  mainWindow.on("closed", () => (mainWindow = null));
}

// Khá»Ÿi táº¡o cá»­a sá»• Ä‘Äƒng nháº­p Ä‘áº§u tiÃªn
app.whenReady().then(createLoginWindow);

// ================================ FILE TXT ================================
// ipcMain.on("export-annotations", (event, yoloText, imagePath) => {
//   // Kiá»ƒm tra imagePath
//   if (!imagePath || typeof imagePath !== "string") {
//     console.error("âŒ imagePath khÃ´ng há»£p lá»‡:", imagePath);
//     event.reply("export-result", "error: imagePath khÃ´ng há»£p lá»‡");
//     return;
//   }
//   // if (!fs.existsSync(imagePath)) {
//   //   console.error("âŒ File áº£nh khÃ´ng tá»“n táº¡i:", imagePath);
//   //   event.reply("export-result", "error: file áº£nh khÃ´ng tá»“n táº¡i");
//   //   return;
//   // }

//   // Táº¡o thÆ° má»¥c labels náº¿u chÆ°a tá»“n táº¡i
//   const labelsDir = path.join(
//     __dirname,
//     "..",
//     "..",
//     "backend",
//     "dataset",
//     "labels",
//     "train"
//   );
//   if (!fs.existsSync(labelsDir)) {
//     fs.mkdirSync(labelsDir, { recursive: true });
//   }

//   console.log("Image path:", imagePath);
//   const baseName = path.basename(imagePath, path.extname(imagePath));
//   const filePath = path.join(labelsDir, baseName + ".txt");

//   // Ghi file .txt theo Ä‘á»‹nh dáº¡ng YOLOv8
//   fs.writeFile(filePath, yoloText, (err) => {
//     if (err) {
//       console.error("âŒ Lá»—i khi lÆ°u file labels:", err);
//       event.reply("export-result", "error");
//     } else {
//       console.log(`âœ… File labels Ä‘Ã£ lÆ°u: ${filePath}`);
//       event.reply("export-result", "success");
//     }
//   });
// });
ipcMain.on("export-annotations", (event, yoloText, imagePath, updateResult) => {
  console.log(`updateResult: ${updateResult}`);

  // Kiá»ƒm tra imagePath
  if (!imagePath || typeof imagePath !== "string") {
    console.error("âŒ imagePath khÃ´ng há»£p lá»‡:", imagePath);
    event.reply("export-result", "error: imagePath khÃ´ng há»£p lá»‡");
    return;
  }

  // Äáº·t Ä‘Æ°á»ng dáº«n cá»‘ Ä‘á»‹nh cho thÆ° má»¥c labels
  const defaultLabelsDir =
    "C:/AHSO/Camera-Control-Basler/my-electron-app - Copy/backend/dataset/labels";

  // Táº¡o thÆ° má»¥c labels/train vÃ  labels/val theo cáº¥u trÃºc cá»‘ Ä‘á»‹nh
  const labelsTrainDir = path.join(defaultLabelsDir, "train");
  const labelsValDir = path.join(defaultLabelsDir, "val");

  // Kiá»ƒm tra vÃ  táº¡o náº¿u khÃ´ng tá»“n táº¡i
  if (!fs.existsSync(labelsTrainDir)) {
    fs.mkdirSync(labelsTrainDir, { recursive: true });
  }
  if (!fs.existsSync(labelsValDir)) {
    fs.mkdirSync(labelsValDir, { recursive: true });
  }

  console.log("Image path:", imagePath);
  const baseName = path.basename(imagePath, path.extname(imagePath));

  // Táº¡o Ä‘Æ°á»ng dáº«n file cho cáº£ train vÃ  val
  const trainFilePath = path.join(labelsTrainDir, baseName + ".txt");
  const valFilePath = path.join(labelsValDir, baseName + ".txt");

  // Ghi file .txt cho cáº£ train vÃ  val sá»­ dá»¥ng Promise Ä‘á»ƒ Ä‘áº£m báº£o hoÃ n thÃ nh trÆ°á»›c khi gá»­i pháº£n há»“i
  const writeTrain = new Promise((resolve, reject) => {
    fs.writeFile(trainFilePath, yoloText, (err) => {
      if (err) {
        console.error("âŒ Lá»—i khi lÆ°u file labels (train):", err);
        reject(err);
      } else {
        console.log(`âœ… File labels Ä‘Ã£ lÆ°u (train): ${trainFilePath}`);
        resolve();
      }
    });
  });

  const writeVal = new Promise((resolve, reject) => {
    fs.writeFile(valFilePath, yoloText, (err) => {
      if (err) {
        console.error("âŒ Lá»—i khi lÆ°u file labels (val):", err);
        reject(err);
      } else {
        console.log(`âœ… File labels Ä‘Ã£ lÆ°u (val): ${valFilePath}`);
        resolve();
      }
    });
  });

  Promise.all([writeTrain, writeVal])
    .then(() => {
      event.reply("export-result", "success");
    })
    .catch((err) => {
      event.reply("export-result", "error");
    });
});


// Xá»­ lÃ½ Ä‘á»c annotation YOLOv8
ipcMain.handle("read-annotations", async (event, imageName) => {
  const baseName = path.parse(imageName).name;

  const labelsDir = path.join(
    __dirname,
    "..",
    "..",
    "backend",
    "dataset",
    "labels",
    "train"
  );
  const filePath = path.join(labelsDir, `${baseName}.txt`);

  try {
    if (fs.existsSync(filePath)) {
      const fileContent = fs.readFileSync(filePath, "utf8");
      return fileContent;
    } else {
      return null;
    }
  } catch (err) {
    console.error("Error reading annotations file:", err);
    return null;
  }
});
// Gá»­i Ä‘Æ°á»ng dáº«n cá»§a folder hÃ¬nh áº£nh
ipcMain.handle("select-image-folder", async () => {
  const result = await dialog.showOpenDialog({
    properties: ["openDirectory"],
  });
  if (!result.canceled && result.filePaths && result.filePaths[0]) {
    return result.filePaths[0];
  }
  return null;
});
// Handler Ä‘á»c danh sÃ¡ch file áº£nh tá»« folder
ipcMain.handle("read-images-from-folder", async (event, folderPath) => {
  try {
    const files = fs.readdirSync(folderPath);
    // Lá»c ra cÃ¡c file cÃ³ Ä‘á»‹nh dáº¡ng hÃ¬nh áº£nh
    const imageFiles = files.filter((file) => {
      const ext = path.extname(file).toLowerCase();
      return [".png", ".jpg", ".jpeg", ".gif", ".bmp"].includes(ext);
    });
    // Chuyá»ƒn Ä‘á»•i thÃ nh Ä‘Æ°á»ng dáº«n tuyá»‡t Ä‘á»‘i cho tá»«ng file
    const absolutePaths = imageFiles.map((file) => path.join(folderPath, file));
    return absolutePaths;
  } catch (error) {
    console.error("Error reading folder:", error);
    return [];
  }
});

// Handler cáº­p nháº­t dataset.yaml
// ipcMain.handle("update-dataset", async (event, folderPath) => {
//   console.log("update-datasetupdate-datasetupdate-datasetupdate-dataset");
//   try {
//     // Cáº¥u hÃ¬nh dataset theo Ä‘á»‹nh dáº¡ng YOLO (vÃ­ dá»¥ sá»­ dá»¥ng cÃ¹ng folder cho train vÃ  val)
//     const datasetConfig = {
//       train: folderPath,
//       val: folderPath, // Náº¿u cÃ³ folder validation khÃ¡c, thay Ä‘á»•i á»Ÿ Ä‘Ã¢y
//       nc: 2, // Sá»‘ lÆ°á»£ng class (cáº­p nháº­t theo dá»± Ã¡n cá»§a báº¡n)
//       names: ["OK", "NG"], // Danh sÃ¡ch tÃªn class (cáº­p nháº­t theo dá»± Ã¡n)
//     };

//     const yamlContent = yaml.dump(datasetConfig, {
//       sortKeys: false,
//       lineWidth: -1,
//     });
//     // ÄÆ°á»ng dáº«n file dataset.yaml (cáº­p nháº­t theo cáº¥u trÃºc dá»± Ã¡n cá»§a báº¡n)
//     const datasetFilePath = path.join(
//       __dirname,
//       "..",
//       "..",
//       "backend",
//       "dataset",
//       "data.yaml"
//     );

//     // Táº¡o thÆ° má»¥c náº¿u chÆ°a tá»“n táº¡i
//     const datasetDir = path.dirname(datasetFilePath);
//     if (!fs.existsSync(datasetDir)) {
//       fs.mkdirSync(datasetDir, { recursive: true });
//     }

//     fs.writeFileSync(datasetFilePath, yamlContent, "utf8");
//     console.log("dataset.yaml updated at:", datasetFilePath);
//     return {
//       success: true,
//       message: "Dataset updated successfully",
//       path: datasetFilePath,
//     };
//   } catch (err) {
//     console.error("Error updating dataset.yaml:", err);
//     return { success: false, message: err.message };
//   }
// });
ipcMain.handle("update-dataset", async (event, folderPath) => {
  console.log("ðŸ”„ Cáº­p nháº­t data.yaml...");

  try {
    // Äáº·t Ä‘Æ°á»ng dáº«n cá»‘ Ä‘á»‹nh cho thÆ° má»¥c labels
    const defaultLabelsDir =
      "C:/AHSO/Camera-Control-Basler/my-electron-app - Copy/backend/dataset/labels";

    // Äáº·t Ä‘Æ°á»ng dáº«n cho thÆ° má»¥c train vÃ  val tá»« folderPath (cÃ³ thá»ƒ thay Ä‘á»•i theo ngÆ°á»i dÃ¹ng chá»n)
    const labelsTrainPath = path.join(defaultLabelsDir, "train");
    const labelsValPath = path.join(defaultLabelsDir, "val");

    // Kiá»ƒm tra náº¿u thÆ° má»¥c labels/train vÃ  labels/val cÃ³ tá»“n táº¡i khÃ´ng
    if (!fs.existsSync(labelsTrainPath) || !fs.existsSync(labelsValPath)) {
      console.error("âŒ KhÃ´ng tÃ¬m tháº¥y thÆ° má»¥c labels/train hoáº·c labels/val!");
      return {
        success: false,
        message: "ThÆ° má»¥c labels/train hoáº·c labels/val khÃ´ng tá»“n táº¡i!",
      };
    }

    // Cáº¥u hÃ¬nh dataset vá»›i Ä‘Æ°á»ng dáº«n tÃ¹y biáº¿n cho train vÃ  val, cÃ²n labels luÃ´n lÃ  cá»‘ Ä‘á»‹nh
    const datasetConfig = {
      train: folderPath, // ÄÆ°á»ng dáº«n tÃ¹y biáº¿n cho train (do ngÆ°á»i dÃ¹ng chá»n)
      val: folderPath, // ÄÆ°á»ng dáº«n tÃ¹y biáº¿n cho val (do ngÆ°á»i dÃ¹ng chá»n)
      nc: 2, // Sá»‘ lÆ°á»£ng class
      names: ["OK", "NG"], // Danh sÃ¡ch cÃ¡c class
    };

    // Táº¡o ná»™i dung YAML
    const yamlContent = yaml.dump(datasetConfig, {
      sortKeys: false,
      lineWidth: -1,
    });

    // In ná»™i dung YAML ra console Ä‘á»ƒ kiá»ƒm tra
    console.log("Ná»™i dung YAML táº¡o Ä‘Æ°á»£c:", yamlContent);

    // LÆ°u file data.yaml vÃ o thÆ° má»¥c cha cá»§a folderPath
    const parentDir = path.dirname(folderPath); // ThÆ° má»¥c cha chá»©a images
    const datasetFilePath = path.join(parentDir, "data.yaml");

    // Táº¡o thÆ° má»¥c cha náº¿u chÆ°a tá»“n táº¡i
    const datasetDir = path.dirname(datasetFilePath);
    if (!fs.existsSync(datasetDir)) {
      fs.mkdirSync(datasetDir, { recursive: true });
    }

    // Ghi ná»™i dung vÃ o file data.yaml
    fs.writeFileSync(datasetFilePath, yamlContent, "utf8");

    // Kiá»ƒm tra náº¿u file Ä‘Ã£ Ä‘Æ°á»£c ghi thÃ nh cÃ´ng
    if (fs.existsSync(datasetFilePath)) {
      console.log("âœ… data.yaml Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t:", datasetFilePath);
    } else {
      console.error("âŒ KhÃ´ng thá»ƒ ghi file data.yaml!");
    }

    return {
      success: true,
      message: "Dataset updated successfully",
      path: datasetFilePath,
    };
  } catch (err) {
    console.error("âŒ Lá»—i cáº­p nháº­t data.yaml:", err);
    return { success: false, message: err.message };
  }
});

// IPC: Sau khi login thÃ nh cÃ´ng, Ä‘Ã³ng cá»­a sá»• login vÃ  má»Ÿ cá»­a sá»• chÃ­nh
ipcMain.on("login-success", () => {
  if (loginWindow) {
    loginWindow.close();
  }
  createMainWindow();
});

// IPC: Láº¯ng nghe sá»± kiá»‡n "logout" tá»« renderer
ipcMain.on("logout", () => {
  if (mainWindow) {
    mainWindow.close();
  }
  createLoginWindow();
});

// ÄÃ³ng app khi táº¥t cáº£ cá»­a sá»• Ä‘Ã£ Ä‘Ã³ng (trá»« macOS)
app.on("window-all-closed", () => {
  if (process.platform !== "darwin") app.quit();
});
